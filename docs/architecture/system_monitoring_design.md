# ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–è¨­è¨ˆæ›¸

## æ¦‚è¦

æ ªä¾¡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚·ã‚¹ãƒ†ãƒ ã®ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–æ©Ÿèƒ½ã®è¨­è¨ˆä»•æ§˜æ›¸ã§ã™ã€‚
ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ³3ã®UI/UXæ”¹å–„ãƒ»ãƒã‚°ä¿®æ­£ã«ãŠã„ã¦ã€ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®å¯è¦–åŒ–ã¨æ¥ç¶šãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## ç›®æ¬¡

- [ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–è¨­è¨ˆæ›¸](#ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–è¨­è¨ˆæ›¸)
  - [æ¦‚è¦](#æ¦‚è¦)
  - [ç›®æ¬¡](#ç›®æ¬¡)
  - [1. åŸºæœ¬æ–¹é‡](#1-åŸºæœ¬æ–¹é‡)
    - [1.1 è¨­è¨ˆç†å¿µ](#11-è¨­è¨ˆç†å¿µ)
    - [1.2 ç›£è¦–å¯¾è±¡](#12-ç›£è¦–å¯¾è±¡)
  - [2. ç›£è¦–æ©Ÿèƒ½è¨­è¨ˆ](#2-ç›£è¦–æ©Ÿèƒ½è¨­è¨ˆ)
    - [2.1 ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç›£è¦–](#21-ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç›£è¦–)
    - [2.2 æ¥ç¶šãƒ†ã‚¹ãƒˆæ©Ÿèƒ½](#22-æ¥ç¶šãƒ†ã‚¹ãƒˆæ©Ÿèƒ½)
    - [2.3 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–](#23-ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–)
  - [3. UI/UXè¨­è¨ˆ](#3-uiuxè¨­è¨ˆ)
    - [3.1 ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º](#31-ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º)
    - [3.2 ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿](#32-ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿)
    - [3.3 æ“ä½œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«](#33-æ“ä½œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«)
  - [4. APIè¨­è¨ˆ](#4-apiè¨­è¨ˆ)
    - [4.1 æ¥ç¶šãƒ†ã‚¹ãƒˆAPI](#41-æ¥ç¶šãƒ†ã‚¹ãƒˆapi)
    - [4.2 ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹API](#42-ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹api)
    - [4.3 ç›£è¦–ãƒ‡ãƒ¼ã‚¿API](#43-ç›£è¦–ãƒ‡ãƒ¼ã‚¿api)
  - [5. å®Ÿè£…ä»•æ§˜](#5-å®Ÿè£…ä»•æ§˜)
    - [5.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…](#51-ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…)
    - [5.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…](#52-ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…)
    - [5.3 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°](#53-ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°)
  - [6. ãƒ†ã‚¹ãƒˆä»•æ§˜](#6-ãƒ†ã‚¹ãƒˆä»•æ§˜)
    - [6.1 æ¥ç¶šãƒ†ã‚¹ãƒˆé …ç›®](#61-æ¥ç¶šãƒ†ã‚¹ãƒˆé …ç›®)
    - [6.2 çŠ¶æ…‹ç›£è¦–ãƒ†ã‚¹ãƒˆ](#62-çŠ¶æ…‹ç›£è¦–ãƒ†ã‚¹ãƒˆ)
    - [6.3 UIå‹•ä½œãƒ†ã‚¹ãƒˆ](#63-uiå‹•ä½œãƒ†ã‚¹ãƒˆ)
  - [7. é‹ç”¨è€ƒæ…®äº‹é …](#7-é‹ç”¨è€ƒæ…®äº‹é …)
    - [7.1 ç›£è¦–é–“éš”](#71-ç›£è¦–é–“éš”)
    - [7.2 ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š](#72-ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š)
    - [7.3 ãƒ­ã‚°ç®¡ç†](#73-ãƒ­ã‚°ç®¡ç†)

## 1. åŸºæœ¬æ–¹é‡

### 1.1 è¨­è¨ˆç†å¿µ

- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯è¦–åŒ–**: ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’å³åº§ã«æŠŠæ¡å¯èƒ½
- **ã‚·ãƒ³ãƒ—ãƒ«ãªæ“ä½œ**: ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã®æ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- **ç›´æ„Ÿçš„ãªè¡¨ç¤º**: è‰²åˆ†ã‘ã«ã‚ˆã‚‹çŠ¶æ…‹ã®è¦–è¦šçš„ç†è§£
- **é‹ç”¨åŠ¹ç‡åŒ–**: å•é¡Œã®æ—©æœŸç™ºè¦‹ã¨å¯¾å¿œæ”¯æ´

### 1.2 ç›£è¦–å¯¾è±¡

| ç›£è¦–é …ç›® | é‡è¦åº¦ | èª¬æ˜ |
|----------|--------|------|
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š** | é«˜ | PostgreSQLæ¥ç¶šçŠ¶æ…‹ |
| **Yahoo Finance API** | é«˜ | å¤–éƒ¨APIæ¥ç¶šçŠ¶æ…‹ |
| **ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒçŠ¶æ³** | ä¸­ | å…¨ä½“çš„ãªã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§ |
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡** | ä½ | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚½ãƒ¼ã‚¹ç›£è¦–ï¼ˆå°†æ¥å®Ÿè£…ï¼‰ |
| **ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡** | ä½ | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç›£è¦–ï¼ˆå°†æ¥å®Ÿè£…ï¼‰ |

## 2. ç›£è¦–æ©Ÿèƒ½è¨­è¨ˆ

### 2.1 ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç›£è¦–

#### 2.1.1 çŠ¶æ…‹ãƒ¬ãƒ™ãƒ«å®šç¾©

```javascript
const StatusLevel = {
  HEALTHY: {
    level: 'healthy',
    color: '#10b981',
    backgroundColor: '#dcfce7',
    label: 'æ­£å¸¸',
    icon: 'âœ…'
  },
  WARNING: {
    level: 'warning',
    color: '#f59e0b',
    backgroundColor: '#fef3c7',
    label: 'è­¦å‘Š',
    icon: 'âš ï¸'
  },
  ERROR: {
    level: 'error',
    color: '#ef4444',
    backgroundColor: '#fee2e2',
    label: 'ã‚¨ãƒ©ãƒ¼',
    icon: 'âŒ'
  },
  UNKNOWN: {
    level: 'unknown',
    color: '#6b7280',
    backgroundColor: '#f3f4f6',
    label: 'ç¢ºèªä¸­',
    icon: 'â“'
  }
};
```

#### 2.1.2 ç›£è¦–é …ç›®è©³ç´°

##### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç›£è¦–
```javascript
const DatabaseMonitor = {
  // æ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  testConnection: async function() {
    try {
      const startTime = Date.now();
      const response = await fetch('/api/system/db-connection-test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      const endTime = Date.now();
      const responseTime = endTime - startTime;

      const result = await response.json();

      return {
        success: result.success,
        responseTime: responseTime,
        message: result.message,
        details: {
          host: result.host,
          database: result.database,
          connectionCount: result.connectionCount
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.message,
        responseTime: null
      };
    }
  }
};
```

##### Yahoo Finance APIç›£è¦–
```javascript
const ApiMonitor = {
  testConnection: async function(symbol = '7203.T') {
    try {
      const startTime = Date.now();
      const response = await fetch('/api/system/api-connection-test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symbol })
      });
      const endTime = Date.now();
      const responseTime = endTime - startTime;

      const result = await response.json();

      return {
        success: result.success,
        responseTime: responseTime,
        message: result.message,
        details: {
          symbol: symbol,
          dataPoints: result.dataPoints,
          lastUpdate: result.lastUpdate
        }
      };
    } catch (error) {
      return {
        success: false,
        error: error.message,
        responseTime: null
      };
    }
  }
};
```

### 2.2 æ¥ç¶šãƒ†ã‚¹ãƒˆæ©Ÿèƒ½

#### 2.2.1 ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[ãƒ†ã‚¹ãƒˆé–‹å§‹] --> B[ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹è¡¨ç¤º]
    B --> C[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ]
    C --> D[APIãƒ†ã‚¹ãƒˆå®Ÿè¡Œ]
    D --> E[çµæœé›†è¨ˆ]
    E --> F[ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°]
    F --> G[æœ€çµ‚ç¢ºèªæ™‚åˆ»æ›´æ–°]
    G --> H[å®Œäº†]

    C --> C1[æ¥ç¶šæˆåŠŸ?]
    C1 -->|Yes| C2[æ­£å¸¸ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹]
    C1 -->|No| C3[ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹]

    D --> D1[APIå¿œç­”ç¢ºèª?]
    D1 -->|Yes| D2[æ­£å¸¸ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹]
    D1 -->|No| D3[ã‚¨ãƒ©ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹]
```

#### 2.2.2 ãƒ†ã‚¹ãƒˆé …ç›®

##### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
- **æ¥ç¶šç¢ºèª**: PostgreSQLæ¥ç¶šã®æˆåŠŸ/å¤±æ•—
- **å¿œç­”æ™‚é–“**: æ¥ç¶šç¢ºç«‹ã¾ã§ã®æ™‚é–“
- **æ¥ç¶šæ•°**: ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ¥ç¶šæ•°
- **ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª**: `stocks_daily`ãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ç¢ºèª

##### APIãƒ†ã‚¹ãƒˆ
- **å¤–éƒ¨APIæ¥ç¶š**: Yahoo Finance APIã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
- **ãƒ‡ãƒ¼ã‚¿å–å¾—**: ã‚µãƒ³ãƒ—ãƒ«éŠ˜æŸ„ï¼ˆ7203.Tï¼‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—
- **å¿œç­”æ™‚é–“**: APIå¿œç­”æ™‚é–“ã®æ¸¬å®š
- **ãƒ‡ãƒ¼ã‚¿å½¢å¼**: è¿”å´ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ç¢ºèª

### 2.3 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–

#### 2.3.1 è‡ªå‹•ç›£è¦–æ©Ÿèƒ½

```javascript
const AutoMonitor = {
  interval: 300000, // 5åˆ†é–“éš”
  isRunning: false,

  start: function() {
    if (this.isRunning) return;

    this.isRunning = true;
    this.intervalId = setInterval(() => {
      this.runHealthCheck();
    }, this.interval);

    // åˆå›å®Ÿè¡Œ
    this.runHealthCheck();
  },

  stop: function() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    this.isRunning = false;
  },

  runHealthCheck: async function() {
    try {
      const [dbResult, apiResult] = await Promise.all([
        DatabaseMonitor.testConnection(),
        ApiMonitor.testConnection()
      ]);

      SystemStatus.updateStatus('database', dbResult);
      SystemStatus.updateStatus('api', apiResult);
      SystemStatus.updateOverallStatus();

    } catch (error) {
      console.error('Auto monitor error:', error);
    }
  }
};
```

## 3. UI/UXè¨­è¨ˆ

### 3.1 ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º

#### 3.1.1 ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæ§‹æˆ

```html
<!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<section id="system-status" class="card system-status-section">
  <header class="card-header">
    <h2 class="card-title">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h2>
    <div class="header-actions">
      <button type="button" id="auto-monitor-toggle" class="btn btn-outline-secondary btn-sm">
        <span class="auto-monitor-icon">ğŸ”„</span>
        <span class="auto-monitor-text">è‡ªå‹•ç›£è¦–: OFF</span>
      </button>
      <button type="button" id="refresh-status-btn" class="btn btn-primary btn-sm">
        <span class="refresh-icon">ğŸ”„</span>
        æ‰‹å‹•æ›´æ–°
      </button>
    </div>
  </header>

  <div class="card-body">
    <!-- ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="overall-status">
      <div class="status-summary">
        <div class="status-icon-large" id="overall-status-icon">â“</div>
        <div class="status-info">
          <h3 id="overall-status-text">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªä¸­</h3>
          <p class="status-description" id="overall-status-description">
            ã‚·ã‚¹ãƒ†ãƒ ã®æ¥ç¶šçŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™...
          </p>
        </div>
      </div>
      <div class="last-check-info">
        <small class="text-muted">
          æœ€çµ‚ç¢ºèª: <span id="last-check-time">æœªç¢ºèª</span>
        </small>
      </div>
    </div>

    <!-- å€‹åˆ¥ç›£è¦–é …ç›® -->
    <div class="monitoring-items">
      <!-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›£è¦– -->
      <div class="status-item" id="db-monitoring">
        <div class="status-header">
          <div class="status-label-group">
            <span class="status-icon" id="db-status-icon">â“</span>
            <span class="status-label">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š</span>
          </div>
          <span id="db-status" class="status-indicator status-unknown">ç¢ºèªä¸­</span>
        </div>
        <div class="status-details" id="db-status-details" style="display: none;">
          <div class="detail-item">
            <span class="detail-label">å¿œç­”æ™‚é–“:</span>
            <span id="db-response-time">-</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">æ¥ç¶šæ•°:</span>
            <span id="db-connection-count">-</span>
          </div>
        </div>
        <div class="status-actions">
          <button type="button" id="test-db-connection-btn" class="btn btn-outline-secondary btn-sm">
            æ¥ç¶šãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          </button>
          <button type="button" class="btn btn-link btn-sm toggle-details" data-target="db-status-details">
            è©³ç´°è¡¨ç¤º
          </button>
        </div>
      </div>

      <!-- Yahoo Finance APIç›£è¦– -->
      <div class="status-item" id="api-monitoring">
        <div class="status-header">
          <div class="status-label-group">
            <span class="status-icon" id="api-status-icon">â“</span>
            <span class="status-label">Yahoo Finance API</span>
          </div>
          <span id="api-status" class="status-indicator status-unknown">ç¢ºèªä¸­</span>
        </div>
        <div class="status-details" id="api-status-details" style="display: none;">
          <div class="detail-item">
            <span class="detail-label">å¿œç­”æ™‚é–“:</span>
            <span id="api-response-time">-</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">ãƒ†ã‚¹ãƒˆéŠ˜æŸ„:</span>
            <span id="api-test-symbol">7203.T</span>
          </div>
        </div>
        <div class="status-actions">
          <button type="button" id="test-api-connection-btn" class="btn btn-outline-secondary btn-sm">
            API ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          </button>
          <button type="button" class="btn btn-link btn-sm toggle-details" data-target="api-status-details">
            è©³ç´°è¡¨ç¤º
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
```

### 3.2 ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿

#### 3.2.1 CSSå®Ÿè£…

```css
/* ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º */
.system-status-section {
  margin-bottom: 2rem;
}

.system-status-section .card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  border-bottom: 2px solid var(--border-color);
}

.header-actions {
  display: flex;
  gap: 0.5rem;
}

/* ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
.overall-status {
  background: #fafafa;
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  border: 1px solid var(--border-color);
}

.status-summary {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 0.5rem;
}

.status-icon-large {
  font-size: 2.5rem;
  line-height: 1;
}

.status-info h3 {
  margin: 0 0 0.25rem 0;
  font-size: 1.25rem;
  font-weight: 600;
}

.status-description {
  margin: 0;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.last-check-info {
  text-align: right;
}

/* ç›£è¦–é …ç›® */
.monitoring-items {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.status-item {
  background: var(--background);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 1rem;
  transition: box-shadow 0.2s ease;
}

.status-item:hover {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.status-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.status-label-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.status-icon {
  font-size: 1.25rem;
}

.status-label {
  font-weight: 500;
  color: var(--text-primary);
  font-size: 1rem;
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */
.status-indicator {
  padding: 0.375rem 0.75rem;
  border-radius: 20px;
  font-size: 0.875rem;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
}

.status-indicator.status-healthy {
  background-color: #dcfce7;
  color: #166534;
  border: 1px solid #bbf7d0;
}

.status-indicator.status-warning {
  background-color: #fef3c7;
  color: #92400e;
  border: 1px solid #fde68a;
}

.status-indicator.status-error {
  background-color: #fee2e2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

.status-indicator.status-unknown {
  background-color: #f3f4f6;
  color: #374151;
  border: 1px solid #d1d5db;
}

/* è©³ç´°æƒ…å ± */
.status-details {
  background: #f8fafc;
  border-radius: 6px;
  padding: 0.75rem;
  margin: 0.75rem 0;
  border: 1px solid #e2e8f0;
}

.detail-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.25rem;
}

.detail-item:last-child {
  margin-bottom: 0;
}

.detail-label {
  font-weight: 500;
  color: var(--text-secondary);
  font-size: 0.875rem;
}

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
.status-actions {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.auto-monitor-icon {
  transition: transform 0.3s ease;
}

.auto-monitor-active .auto-monitor-icon {
  animation: spin 2s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
  .system-status-section .card-header {
    flex-direction: column;
    gap: 1rem;
    align-items: stretch;
  }

  .header-actions {
    justify-content: center;
  }

  .status-summary {
    flex-direction: column;
    text-align: center;
  }

  .status-header {
    flex-direction: column;
    align-items: stretch;
    gap: 0.5rem;
  }

  .status-actions {
    justify-content: center;
    flex-wrap: wrap;
  }
}
```

## 4. APIè¨­è¨ˆ

### 4.1 æ¥ç¶šãƒ†ã‚¹ãƒˆAPI

#### 4.1.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ

```python
# app/api/system.py

@app.route('/api/system/db-connection-test', methods=['POST'])
def test_database_connection():
    """
    ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    """
    try:
        start_time = time.time()

        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
        with get_db_session() as session:
            # åŸºæœ¬æ¥ç¶šç¢ºèª
            result = session.execute(text("SELECT 1")).fetchone()

            # ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèª
            table_check = session.execute(
                text("SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'stocks_daily'")
            ).fetchone()

            # æ¥ç¶šæ•°ç¢ºèª
            connection_count = session.execute(
                text("SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active'")
            ).fetchone()

        end_time = time.time()
        response_time = round((end_time - start_time) * 1000, 2)  # ãƒŸãƒªç§’

        return jsonify({
            'success': True,
            'message': 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæ­£å¸¸',
            'responseTime': response_time,
            'details': {
                'host': app.config.get('DB_HOST', 'localhost'),
                'database': app.config.get('DB_NAME', 'stock_db'),
                'tableExists': table_check[0] > 0,
                'connectionCount': connection_count[0] if connection_count else 0
            },
            'timestamp': datetime.now().isoformat()
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼: {str(e)}',
            'error': str(e),
            'timestamp': datetime.now().isoformat()
        }), 500
```

#### 4.1.2 APIæ¥ç¶šãƒ†ã‚¹ãƒˆ

```python
@app.route('/api/system/api-connection-test', methods=['POST'])
def test_api_connection():
    """
    Yahoo Finance APIæ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
    """
    try:
        data = request.get_json()
        test_symbol = data.get('symbol', '7203.T')

        start_time = time.time()

        # Yahoo Finance APIãƒ†ã‚¹ãƒˆ
        import yfinance as yf
        ticker = yf.Ticker(test_symbol)

        # åŸºæœ¬æƒ…å ±å–å¾—ãƒ†ã‚¹ãƒˆ
        info = ticker.info

        # ç›´è¿‘ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ
        hist = ticker.history(period="1d")

        end_time = time.time()
        response_time = round((end_time - start_time) * 1000, 2)  # ãƒŸãƒªç§’

        if hist.empty:
            raise Exception("ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")

        return jsonify({
            'success': True,
            'message': 'Yahoo Finance APIæ¥ç¶šæ­£å¸¸',
            'responseTime': response_time,
            'details': {
                'symbol': test_symbol,
                'dataPoints': len(hist),
                'lastUpdate': hist.index[-1].strftime('%Y-%m-%d') if not hist.empty else None,
                'companyName': info.get('longName', 'N/A')
            },
            'timestamp': datetime.now().isoformat()
        })

    except Exception as e:
        return jsonify({
            'success': False,
            'message': f'APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: {str(e)}',
            'error': str(e),
            'timestamp': datetime.now().isoformat()
        }), 500
```

### 4.2 ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹API

#### 4.2.1 çµ±åˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

```python
@app.route('/api/system/health-check', methods=['GET'])
def system_health_check():
    """
    ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    """
    try:
        health_status = {
            'overall': 'healthy',
            'timestamp': datetime.now().isoformat(),
            'services': {}
        }

        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚§ãƒƒã‚¯
        try:
            with get_db_session() as session:
                session.execute(text("SELECT 1"))
            health_status['services']['database'] = {
                'status': 'healthy',
                'message': 'æ¥ç¶šæ­£å¸¸'
            }
        except Exception as e:
            health_status['services']['database'] = {
                'status': 'error',
                'message': f'æ¥ç¶šã‚¨ãƒ©ãƒ¼: {str(e)}'
            }
            health_status['overall'] = 'error'

        # APIæ¥ç¶šãƒã‚§ãƒƒã‚¯
        try:
            import yfinance as yf
            ticker = yf.Ticker('7203.T')
            hist = ticker.history(period="1d")
            if not hist.empty:
                health_status['services']['api'] = {
                    'status': 'healthy',
                    'message': 'APIæ¥ç¶šæ­£å¸¸'
                }
            else:
                health_status['services']['api'] = {
                    'status': 'warning',
                    'message': 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã§ããš'
                }
                if health_status['overall'] == 'healthy':
                    health_status['overall'] = 'warning'
        except Exception as e:
            health_status['services']['api'] = {
                'status': 'error',
                'message': f'APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: {str(e)}'
            }
            health_status['overall'] = 'error'

        return jsonify(health_status)

    except Exception as e:
        return jsonify({
            'overall': 'error',
            'message': f'ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {str(e)}',
            'timestamp': datetime.now().isoformat()
        }), 500
```

## 5. å®Ÿè£…ä»•æ§˜

### 5.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### 5.1.1 ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç®¡ç†ã‚¯ãƒ©ã‚¹

```javascript
// static/js/system-monitor.js

class SystemMonitor {
  constructor() {
    this.autoMonitorInterval = null;
    this.autoMonitorEnabled = false;
    this.lastCheckTime = null;

    this.initializeEventListeners();
    this.loadInitialStatus();
  }

  initializeEventListeners() {
    // æ‰‹å‹•æ›´æ–°ãƒœã‚¿ãƒ³
    document.getElementById('refresh-status-btn')?.addEventListener('click', () => {
      this.runFullHealthCheck();
    });

    // è‡ªå‹•ç›£è¦–åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('auto-monitor-toggle')?.addEventListener('click', () => {
      this.toggleAutoMonitor();
    });

    // å€‹åˆ¥ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
    document.getElementById('test-db-connection-btn')?.addEventListener('click', () => {
      this.testDatabaseConnection();
    });

    document.getElementById('test-api-connection-btn')?.addEventListener('click', () => {
      this.testApiConnection();
    });

    // è©³ç´°è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.toggle-details').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const targetId = e.target.dataset.target;
        this.toggleDetails(targetId);
      });
    });
  }

  async loadInitialStatus() {
    await this.runFullHealthCheck();
  }

  async runFullHealthCheck() {
    try {
      this.showLoading();

      const [dbResult, apiResult] = await Promise.all([
        this.testDatabaseConnection(),
        this.testApiConnection()
      ]);

      this.updateOverallStatus(dbResult, apiResult);
      this.updateLastCheckTime();

    } catch (error) {
      console.error('Health check error:', error);
      this.showError('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®ç¢ºèªä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      this.hideLoading();
    }
  }

  async testDatabaseConnection() {
    try {
      const response = await fetch('/api/system/db-connection-test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });

      const result = await response.json();
      this.updateDatabaseStatus(result);
      return result;

    } catch (error) {
      const errorResult = {
        success: false,
        message: `æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`,
        error: error.message
      };
      this.updateDatabaseStatus(errorResult);
      return errorResult;
    }
  }

  async testApiConnection() {
    try {
      const response = await fetch('/api/system/api-connection-test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ symbol: '7203.T' })
      });

      const result = await response.json();
      this.updateApiStatus(result);
      return result;

    } catch (error) {
      const errorResult = {
        success: false,
        message: `APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`,
        error: error.message
      };
      this.updateApiStatus(errorResult);
      return errorResult;
    }
  }

  updateDatabaseStatus(result) {
    const statusElement = document.getElementById('db-status');
    const iconElement = document.getElementById('db-status-icon');
    const responseTimeElement = document.getElementById('db-response-time');
    const connectionCountElement = document.getElementById('db-connection-count');

    if (result.success) {
      this.setStatusIndicator(statusElement, 'healthy', 'æ­£å¸¸');
      iconElement.textContent = 'âœ…';

      if (result.responseTime) {
        responseTimeElement.textContent = `${result.responseTime}ms`;
      }

      if (result.details?.connectionCount !== undefined) {
        connectionCountElement.textContent = `${result.details.connectionCount}å€‹`;
      }
    } else {
      this.setStatusIndicator(statusElement, 'error', 'ã‚¨ãƒ©ãƒ¼');
      iconElement.textContent = 'âŒ';
      responseTimeElement.textContent = '-';
      connectionCountElement.textContent = '-';
    }
  }

  updateApiStatus(result) {
    const statusElement = document.getElementById('api-status');
    const iconElement = document.getElementById('api-status-icon');
    const responseTimeElement = document.getElementById('api-response-time');
    const testSymbolElement = document.getElementById('api-test-symbol');

    if (result.success) {
      this.setStatusIndicator(statusElement, 'healthy', 'æ­£å¸¸');
      iconElement.textContent = 'âœ…';

      if (result.responseTime) {
        responseTimeElement.textContent = `${result.responseTime}ms`;
      }

      if (result.details?.symbol) {
        testSymbolElement.textContent = result.details.symbol;
      }
    } else {
      this.setStatusIndicator(statusElement, 'error', 'ã‚¨ãƒ©ãƒ¼');
      iconElement.textContent = 'âŒ';
      responseTimeElement.textContent = '-';
    }
  }

  updateOverallStatus(dbResult, apiResult) {
    const iconElement = document.getElementById('overall-status-icon');
    const textElement = document.getElementById('overall-status-text');
    const descriptionElement = document.getElementById('overall-status-description');

    const dbHealthy = dbResult?.success ?? false;
    const apiHealthy = apiResult?.success ?? false;

    if (dbHealthy && apiHealthy) {
      iconElement.textContent = 'âœ…';
      textElement.textContent = 'ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸ç¨¼åƒä¸­';
      descriptionElement.textContent = 'ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚';
      textElement.style.color = '#166534';
    } else if (dbHealthy || apiHealthy) {
      iconElement.textContent = 'âš ï¸';
      textElement.textContent = 'ã‚·ã‚¹ãƒ†ãƒ éƒ¨åˆ†ç¨¼åƒä¸­';
      descriptionElement.textContent = 'ä¸€éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚';
      textElement.style.color = '#92400e';
    } else {
      iconElement.textContent = 'âŒ';
      textElement.textContent = 'ã‚·ã‚¹ãƒ†ãƒ éšœå®³ç™ºç”Ÿ';
      descriptionElement.textContent = 'è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã§å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ã€‚';
      textElement.style.color = '#991b1b';
    }
  }

  setStatusIndicator(element, status, text) {
    if (!element) return;

    // ã‚¯ãƒ©ã‚¹ãƒªã‚»ãƒƒãƒˆ
    element.className = 'status-indicator';

    // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¨­å®š
    element.classList.add(`status-${status}`);
    element.textContent = text;
  }

  toggleAutoMonitor() {
    if (this.autoMonitorEnabled) {
      this.stopAutoMonitor();
    } else {
      this.startAutoMonitor();
    }
  }

  startAutoMonitor() {
    this.autoMonitorEnabled = true;
    this.autoMonitorInterval = setInterval(() => {
      this.runFullHealthCheck();
    }, 300000); // 5åˆ†é–“éš”

    const toggleBtn = document.getElementById('auto-monitor-toggle');
    const textElement = toggleBtn.querySelector('.auto-monitor-text');

    toggleBtn.classList.add('auto-monitor-active');
    textElement.textContent = 'è‡ªå‹•ç›£è¦–: ON';

    // åˆå›å®Ÿè¡Œ
    this.runFullHealthCheck();
  }

  stopAutoMonitor() {
    this.autoMonitorEnabled = false;

    if (this.autoMonitorInterval) {
      clearInterval(this.autoMonitorInterval);
      this.autoMonitorInterval = null;
    }

    const toggleBtn = document.getElementById('auto-monitor-toggle');
    const textElement = toggleBtn.querySelector('.auto-monitor-text');

    toggleBtn.classList.remove('auto-monitor-active');
    textElement.textContent = 'è‡ªå‹•ç›£è¦–: OFF';
  }

  updateLastCheckTime() {
    const element = document.getElementById('last-check-time');
    if (element) {
      this.lastCheckTime = new Date();
      element.textContent = this.lastCheckTime.toLocaleString('ja-JP');
    }
  }

  toggleDetails(targetId) {
    const element = document.getElementById(targetId);
    if (element) {
      const isVisible = element.style.display !== 'none';
      element.style.display = isVisible ? 'none' : 'block';

      const button = document.querySelector(`[data-target="${targetId}"]`);
      if (button) {
        button.textContent = isVisible ? 'è©³ç´°è¡¨ç¤º' : 'è©³ç´°éè¡¨ç¤º';
      }
    }
  }

  showLoading() {
    const refreshBtn = document.getElementById('refresh-status-btn');
    if (refreshBtn) {
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '<span class="refresh-icon">â³</span> ç¢ºèªä¸­...';
    }
  }

  hideLoading() {
    const refreshBtn = document.getElementById('refresh-status-btn');
    if (refreshBtn) {
      refreshBtn.disabled = false;
      refreshBtn.innerHTML = '<span class="refresh-icon">ğŸ”„</span> æ‰‹å‹•æ›´æ–°';
    }
  }

  showError(message) {
    // ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºï¼ˆErrorHandlerã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨ï¼‰
    if (window.ErrorHandler) {
      window.ErrorHandler.showError(message);
    } else {
      alert(message);
    }
  }
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
  window.systemMonitor = new SystemMonitor();
});
```

## 6. ãƒ†ã‚¹ãƒˆä»•æ§˜

### 6.1 æ¥ç¶šãƒ†ã‚¹ãƒˆé …ç›®

#### 6.1.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] PostgreSQLæ¥ç¶šç¢ºèª
- [ ] æ¥ç¶šå¿œç­”æ™‚é–“æ¸¬å®š
- [ ] ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ç¢ºèªï¼ˆstocks_dailyï¼‰
- [ ] ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ¥ç¶šæ•°å–å¾—
- [ ] æ¥ç¶šã‚¨ãƒ©ãƒ¼æ™‚ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼è¡¨ç¤º

#### 6.1.2 APIãƒ†ã‚¹ãƒˆ
- [ ] Yahoo Finance APIæ¥ç¶šç¢ºèª
- [ ] ãƒ†ã‚¹ãƒˆéŠ˜æŸ„ï¼ˆ7203.Tï¼‰ãƒ‡ãƒ¼ã‚¿å–å¾—
- [ ] APIå¿œç­”æ™‚é–“æ¸¬å®š
- [ ] ãƒ‡ãƒ¼ã‚¿å½¢å¼æ¤œè¨¼
- [ ] API ã‚¨ãƒ©ãƒ¼æ™‚ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼è¡¨ç¤º

### 6.2 çŠ¶æ…‹ç›£è¦–ãƒ†ã‚¹ãƒˆ

#### 6.2.1 UIå‹•ä½œãƒ†ã‚¹ãƒˆ
- [ ] ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®æ­£ç¢ºãªè¡¨ç¤º
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ã®è‰²åˆ†ã‘
- [ ] æ‰‹å‹•æ›´æ–°ãƒœã‚¿ãƒ³ã®å‹•ä½œ
- [ ] è‡ªå‹•ç›£è¦–æ©Ÿèƒ½ã®é–‹å§‹/åœæ­¢
- [ ] è©³ç´°æƒ…å ±ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ

#### 6.2.2 ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºã§ã®é©åˆ‡ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
- [ ] ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆè¡¨ç¤ºã§ã®æ“ä½œæ€§ç¢ºèª
- [ ] ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—è¡¨ç¤ºã§ã®æƒ…å ±è¡¨ç¤º

## 7. é‹ç”¨è€ƒæ…®äº‹é …

### 7.1 ç›£è¦–é–“éš”

- **è‡ªå‹•ç›£è¦–**: 5åˆ†é–“éš”ï¼ˆè¨­å®šå¯èƒ½ï¼‰
- **æ‰‹å‹•æ›´æ–°**: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¢ºèª
- **åˆæœŸèª­ã¿è¾¼ã¿**: ãƒšãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®å³åº§ç¢ºèª

### 7.2 ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

å°†æ¥å®Ÿè£…äºˆå®šï¼š
- **ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ç¶™ç¶šæ™‚**: 3å›é€£ç¶šã‚¨ãƒ©ãƒ¼ã§ã‚¢ãƒ©ãƒ¼ãƒˆ
- **å¿œç­”æ™‚é–“åŠ£åŒ–**: å¹³å‡å¿œç­”æ™‚é–“ã®2å€ã‚’è¶…ãˆãŸå ´åˆ
- **ã‚µãƒ¼ãƒ“ã‚¹å¾©æ—§**: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‹ã‚‰ã®å¾©æ—§é€šçŸ¥

### 7.3 ãƒ­ã‚°ç®¡ç†

å°†æ¥å®Ÿè£…äºˆå®šï¼š
- **æ¥ç¶šãƒ†ã‚¹ãƒˆå±¥æ­´**: éå»24æ™‚é–“ã®æ¥ç¶šãƒ†ã‚¹ãƒˆçµæœ
- **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°**: è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã®è¨˜éŒ²
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ­ã‚°**: å¿œç­”æ™‚é–“ã®æ¨ç§»è¨˜éŒ²

---

ã“ã®è¨­è¨ˆæ›¸ã«åŸºã¥ã„ã¦ã€ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ³3ã®ã‚·ã‚¹ãƒ†ãƒ ç›£è¦–æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’å³åº§ã«æŠŠæ¡ã§ãã‚‹ç’°å¢ƒã‚’æä¾›ã—ã¾ã™ã€‚
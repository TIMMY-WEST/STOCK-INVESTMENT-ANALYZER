# 株価データ取得システム - リファクタリング & 共同開発マイルストン

## 📋 プロジェクト概要
v2.0.0の完成を受けて、共同開発を見据えたアーキテクチャリファクタリングと開発者体験の向上を目指します。

**設計理念**: シンプル化・柔軟性・開発者フレンドリー・保守性の向上

---

## 🏗️ マイルストン 1: アーキテクチャの整理とドキュメント化
**期間目安**: 5-7日
**目標**: 現状の複雑な構造を可視化し、リファクタリング方針を策定

### 📝 主要タスク

#### 1.1 現状分析とドキュメント化
- [ ] **アーキテクチャドキュメント作成**
  - [ ] システム全体のアーキテクチャ図をmermaid形式で作成（`docs/architecture/system_overview.md`）
  - [ ] コンポーネント依存関係図mermaid形式で作成（各サービス間の関係性）
  - [ ] データフロー図mermaid形式で作成（データ取得～保存～表示までの流れ）
- [ ] **モジュール責任の明確化**
  - [ ] 各サービスクラスの責任範囲を文書化（`docs/architecture/service_responsibilities.md`）
  - [ ] 重複機能の洗い出しと統合候補の特定
  - [ ] 不要なコードの特定
- [ ] **APIエンドポイントの整理**
  - [ ] 全エンドポイントの一覧化と用途の文書化
  - [ ] RESTful原則との整合性チェック
  - [ ] 非推奨・削除予定エンドポイントの特定

#### 1.2 開発ガイドラインの策定
- [ ] **コーディング規約の作成**
  - [ ] Python PEP8準拠のスタイルガイド（`docs/development/coding_standards.md`）
  - [ ] 命名規則の統一（変数、関数、クラス、ファイル）
  - [ ] コメント・ドキュメンテーション規約
- [ ] **フォーマッタ・Linterの導入**
  - [ ] Black（コードフォーマッタ）の導入と設定
  - [ ] isort（import文ソート）の導入と設定
  - [ ] flake8（Linter）の導入と設定
  - [ ] pylint（静的解析ツール）の導入検討
  - [ ] `pyproject.toml` での統一設定
  - [ ] VSCode設定ファイルでの自動フォーマット有効化
- [ ] **型チェックの導入**
  - [ ] mypy（型チェッカー）の導入と設定
  - [ ] 型ヒント記述ガイドライン作成
  - [ ] 既存コードへの段階的な型ヒント追加方針
- [ ] **pre-commitフックの設定**
  - [ ] `.pre-commit-config.yaml` の作成
  - [ ] コミット前の自動フォーマット実行
  - [ ] コミット前のLinterチェック
  - [ ] コミット前の型チェック実行
- [ ] **テスト方針の策定**
  - [ ] 単体テスト作成ガイドライン（`docs/development/testing_guide.md`）
  - [ ] 結合テスト作成ガイドライン
  - [ ] テストカバレッジ目標の設定（最低70%）
  - [ ] pytest設定とプラグイン選定（pytest-cov、pytest-mock等）
- [ ] **Gitワークフロー整備（共同開発対応）**
  - [ ] **ブランチ戦略の明確化**（`docs/development/git_workflow.md`）
    - [ ] Git Flow / GitHub Flow の選定と適用
    - [ ] 保護ブランチの設定（`main`, `develop`）
    - [ ] ブランチ命名規則の統一
      - `feature/MS1-add-architecture-docs` - 新機能開発
      - `fix/issue-123-pagination-bug` - バグ修正
      - `refactor/service-layer-cleanup` - リファクタリング
      - `docs/update-api-documentation` - ドキュメント更新
      - `test/add-unit-tests-for-fetcher` - テスト追加
    - [ ] ブランチのライフサイクル管理（作成→開発→レビュー→マージ→削除）
    - [ ] マージ戦略の決定（Squash and Merge / Rebase / Merge Commit）
  - [ ] **ブランチ保護ルールの設定**
    - [ ] `main` ブランチへの直接プッシュ禁止
    - [ ] Pull Request必須化（最低1名のレビュアー承認）
    - [ ] CI/CD全パス必須（テスト・Linter・型チェック）
    - [ ] コンフリクト解決必須
    - [ ] レビュー後の再プッシュ時の再承認設定
  - [ ] **Pull Request運用ルール**
    - [ ] PRテンプレート作成（`.github/PULL_REQUEST_TEMPLATE.md`）
      - 変更内容の説明
      - 関連Issue番号
      - テスト方法
      - スクリーンショット（UI変更時）
      - チェックリスト（テスト済み、ドキュメント更新等）
    - [ ] PR作成時のガイドライン策定
    - [ ] コードレビューガイドライン作成
    - [ ] レビュアー割り当てルール（CODEOWNERS設定検討）
  - [ ] **コミットメッセージ規約**
    - [ ] Conventional Commits採用
      - `feat:` - 新機能
      - `fix:` - バグ修正
      - `refactor:` - リファクタリング
      - `docs:` - ドキュメント更新
      - `test:` - テスト追加・修正
      - `chore:` - ビルド・設定変更
      - `style:` - コードフォーマット
    - [ ] コミットメッセージの書き方ガイド作成
    - [ ] commitlintの導入検討（コミットメッセージ自動検証）
  - [ ] **Issue管理ルール**
    - [ ] Issueテンプレート作成（`.github/ISSUE_TEMPLATE/`）
      - `bug_report.md` - バグ報告
      - `feature_request.md` - 機能要望
      - `question.md` - 質問
      - `refactoring.md` - リファクタリング提案
    - [ ] Issueラベルの体系化（bug, enhancement, documentation, good first issue等）
    - [ ] Issue番号とPRの紐付けルール（`Closes #123` 等）
    - [ ] マイルストンとの紐付けルール
  - [ ] **リリース管理**
    - [ ] タグ付けルール（セマンティックバージョニング：v1.0.0）
    - [ ] リリースノート作成手順
    - [ ] リリースブランチ運用（必要な場合）

### ✅ 完了条件
- [ ] 新規開発者が30分以内にシステム全体を理解できるドキュメントが揃っている
- [ ] 全ての開発ガイドラインが文書化され、アクセス可能である
- [ ] 既存コードの問題点と改善方針が明確になっている
- [ ] フォーマッタとLinterが導入され、自動実行される環境が整っている
- [ ] pre-commitフックが設定され、コミット時に自動チェックが動作する
- [ ] ブランチ保護ルールが設定され、直接プッシュが禁止されている
- [ ] PR/Issueテンプレートが整備され、誰でも使える状態になっている
- [ ] Gitワークフローがドキュメント化され、チーム全体で共有されている

### 📚 成果物
- `docs/architecture/system_overview.md` - システムアーキテクチャ概要
- `docs/architecture/service_responsibilities.md` - サービス責任分掌
- `docs/development/coding_standards.md` - コーディング規約
- `docs/development/testing_guide.md` - テスト作成ガイド
- `docs/development/git_workflow.md` - Git運用ガイド（ブランチ戦略、命名規則、マージ戦略含む）
- `docs/development/code_review_guide.md` - コードレビューガイド
- `.github/PULL_REQUEST_TEMPLATE.md` - PRテンプレート
- `.github/ISSUE_TEMPLATE/bug_report.md` - バグ報告テンプレート
- `.github/ISSUE_TEMPLATE/feature_request.md` - 機能要望テンプレート
- `.github/ISSUE_TEMPLATE/question.md` - 質問テンプレート
- `.github/ISSUE_TEMPLATE/refactoring.md` - リファクタリング提案テンプレート
- `.github/CODEOWNERS` - コードオーナー設定（オプション）
- `pyproject.toml` - Black、isort、flake8、mypyの統一設定
- `.pre-commit-config.yaml` - pre-commitフック設定
- `.commitlintrc.json` - commitlint設定（オプション）
- `.vscode/settings.json` - VSCode自動フォーマット設定
- GitHubリポジトリのブランチ保護設定（mainブランチ）

---

## 📦 マイルストン 2: 開発環境の整備と開発者体験の向上
**期間目安**: 3-5日
**目標**: 新規開発者のオンボーディング時間を最小化

### 📝 主要タスク

#### 2.1 開発環境セットアップの自動化
- [ ] **開発用スクリプトの整備**
  - [ ] ワンコマンドセットアップスクリプト（`make setup` または `scripts/dev_setup.sh/bat`）
  - [ ] データベースリセットスクリプト
  - [ ] サンプルデータ投入スクリプト
  - [ ] 依存関係インストールの自動化
- [ ] **Dockerコンテナ化（将来検討）**
  - [ ] Docker導入の要件整理とメリット・デメリット評価
  - [ ] 導入時期の検討（v3.0以降等）
  - [ ] Docker化の設計ドキュメント作成（オプション）

#### 2.2 開発ツールの統一
- [ ] **エディタ設定の共有**
  - [ ] `.editorconfig` の作成（インデント、文字コード、改行コード統一）
  - [ ] VSCode推奨拡張機能の定義（`.vscode/extensions.json`）
    - Python拡張機能
    - Pylance（型チェック）
    - Black Formatter
    - isort
    - flake8
    - GitLens等
  - [ ] VSCode設定の共有（`.vscode/settings.json`）
    - 保存時の自動フォーマット有効化
    - Linterの自動実行設定
- [ ] **Linter・Formatterの統一（マイルストン1で設定済みの継続確認）**
  - [ ] `pyproject.toml` での設定統一の動作確認
  - [ ] pre-commitフックの動作確認
  - [ ] 全開発者への導入ガイド作成
  - [ ] トラブルシューティングドキュメント作成

#### 2.3 ドキュメントの充実
- [ ] **README.mdの改善**
  - [ ] クイックスタートガイドの強化
  - [ ] トラブルシューティングの充実
  - [ ] よくある質問（FAQ）の追加
- [ ] **CONTRIBUTING.mdの作成**
  - [ ] 貢献方法の明記
  - [ ] 開発フローの説明
  - [ ] コードレビュー基準
- [ ] **アーキテクチャドキュメントの整備**
  - [ ] 図解入りのシステム説明
  - [ ] 各コンポーネントの詳細説明
  - [ ] データフロー図

### ✅ 完了条件
- [ ] 新規開発者が15分以内に開発環境を構築できる
- [ ] ドキュメントを読めば、誰でも開発を開始できる
- [ ] セットアップスクリプトが正常に動作する
- [ ] コードフォーマット・Linterが自動実行される
- [ ] CONTRIBUTING.mdが整備され、開発フローが明確になっている

### 📚 成果物
- `Makefile` または `scripts/dev_setup.sh/bat` - セットアップスクリプト
- `scripts/reset_db.sh/bat` - データベースリセットスクリプト
- `.editorconfig`, `.vscode/` 設定ファイル
- `pyproject.toml` - Python設定統合（マイルストン1で作成済みの確認）
- `CONTRIBUTING.md` - 貢献ガイド
- 更新された `README.md`
- `docs/development/docker_future_plan.md` - Docker導入計画（オプション）

---

## 🧪 マイルストン 3: テスト戦略の策定（フェーズ1）
**期間目安**: 2-3日
**目標**: リファクタリング前にテスト戦略を確立し、既存機能を保護する基盤を作る

> **重要**: このマイルストンでは、リファクタリング中に既存機能を壊さないよう、テスト戦略とルールを先に確立します。既存テストは温存し、リファクタリングの安全網として機能させます。

### 📝 主要タスク

#### 3.1 テスト戦略のドキュメント化とルール化
- [ ] **テスト戦略ドキュメントの作成**（`docs/development/testing_strategy.md`）
  - [ ] テストの目的と重要性の明記
  - [ ] テストレベルの定義（ユニット・統合・E2E）
  - [ ] テストカバレッジ目標の設定（70%以上）
  - [ ] 各レベルのテスト範囲と責任の明確化
- [ ] **テスト作成ルールの策定**
  - [ ] テストファイル命名規則（`test_*.py` または `*_test.py`）
  - [ ] テスト関数命名規則（`test_<機能>_<条件>_<期待結果>`）
  - [ ] AAAパターンの適用ルール（Arrange-Act-Assert）
  - [ ] テストデータの管理方法（フィクスチャ、ファクトリー）
  - [ ] モック使用のガイドライン
- [ ] **テスト実行ルールの策定**
  - [ ] ローカルでのテスト実行義務（コミット前）
  - [ ] PR作成前の全テスト通過必須
  - [ ] テスト失敗時の対応手順
  - [ ] テストスキップの禁止（例外的な場合のみ許可し、理由を明記）

#### 3.2 テスト環境の基本セットアップ
- [ ] **テストディレクトリ構造の作成**
  - [ ] `tests/unit/` - ユニットテスト用ディレクトリ作成
  - [ ] `tests/integration/` - 統合テスト用ディレクトリ作成
  - [ ] `tests/e2e/` - E2Eテスト用ディレクトリ作成
  - [ ] `tests/conftest.py` - 共通フィクスチャ用ファイル作成
  - [ ] **既存テストは現在の場所に温存**（リファクタリングの安全網として機能）
- [ ] **pytest基本設定**
  - [ ] `pytest.ini` または `pyproject.toml` でのpytest設定
  - [ ] pytest-cov（カバレッジ）プラグインの導入
  - [ ] pytest-mock（モック）プラグインの導入
  - [ ] テスト実行コマンドの標準化（`pytest tests/`）

#### 3.3 基本的なテストユーティリティの整備
- [ ] **共通フィクスチャの作成**（`tests/conftest.py`）
  - [ ] テスト用データベースセットアップ/ティアダウン
  - [ ] テストデータファクトリー（基本的なもののみ）
  - [ ] モックヘルパー（Yahoo Finance API等）
- [ ] **テスト実行ガイドの作成**（`tests/README.md`）
  - [ ] テストの実行方法
  - [ ] カバレッジレポートの確認方法
  - [ ] トラブルシューティング

### ✅ 完了条件
- [ ] テスト戦略ドキュメントが完成し、チーム全体で共有されている
- [ ] テスト作成・実行ルールが明文化されている
- [ ] テストディレクトリ構造が整備されている
- [ ] pytest基本設定が完了し、テストが実行できる
- [ ] **既存テストがすべて正常に動作している**（温存されている）
- [ ] 開発者がテストドキュメントを読めば、新規テストを書ける状態になっている

### 📚 成果物
- `docs/development/testing_strategy.md` - テスト戦略ドキュメント
  - テストの目的と重要性
  - テストレベルの定義と範囲
  - テストカバレッジ目標
  - テスト作成ルール（命名規則、AAAパターン等）
  - テスト実行ルール（コミット前テスト必須等）
  - モック・フィクスチャ使用ガイドライン
- `tests/unit/`, `tests/integration/`, `tests/e2e/` - テストディレクトリ構造
- `tests/conftest.py` - 基本的な共通フィクスチャ
- `tests/README.md` - テスト実行ガイド
- `pytest.ini` または `pyproject.toml` - pytest設定

> **次のマイルストンへ**: この段階でテスト戦略とルールが確立されます。マイルストン4-6でリファクタリングを行う際は、新規コードに対して策定したルールに従ってテストを作成します。既存テストはリファクタリングの安全網として機能させ、マイルストン7で新ルールに準拠するよう整理します。

---

## 🔨 マイルストン 4: コア機能のリファクタリング（サービス層）
**期間目安**: 7-10日
**目標**: サービス層のシンプル化と責任の明確化

> **重要**: リファクタリング時は、既存テストを必ず実行して機能が壊れていないことを確認しながら進めます。新規コードには、マイルストン3で策定したルールに従ってテストを作成します。

### 📝 主要タスク

#### 4.1 データ取得サービスの統合
- [ ] **Stock Data Fetcher の整理**
  - [ ] `stock_data_fetcher.py` の単一責任原則への準拠
  - [ ] Yahoo Finance APIとの通信ロジックのみに集中
  - [ ] エラーハンドリングの一貫性確保
- [ ] **Orchestrator の簡素化**
  - [ ] `stock_data_orchestrator.py` の責任範囲を明確化
  - [ ] 複雑な分岐ロジックの削減
  - [ ] 設定ベースの動作制御への移行
- [ ] **重複コードの削減**
  - [ ] `batch_service.py` と `bulk_data_service.py` の統合検討
  - [ ] 共通ユーティリティの抽出（`app/utils/common.py`）

#### 4.2 データ保存サービスの最適化
- [ ] **Stock Data Saver の改善**
  - [ ] `stock_data_saver.py` のトランザクション処理の見直し
  - [ ] バルクインサート処理の最適化
  - [ ] エラーリカバリー機能の強化
- [ ] **データベース接続管理**
  - [ ] コネクションプールの適切な設定
  - [ ] セッション管理のベストプラクティス適用

#### 4.3 エラーハンドリングの統一
- [ ] **エラーハンドラーの改善**
  - [ ] `error_handler.py` の拡充
  - [ ] カスタム例外クラスの体系化（`app/exceptions.py`）
  - [ ] エラーログの構造化と一貫性確保
- [ ] **ユーザーフレンドリーなエラーメッセージ**
  - [ ] エラーコード体系の導入
  - [ ] 多言語対応を見据えたメッセージ管理

### ✅ 完了条件
- [ ] サービス層のコードが単一責任原則に従っている
- [ ] 重複コードが80%以上削減されている
- [ ] 全てのサービスに単体テストが存在し、カバレッジ70%以上
- [ ] エラーハンドリングが統一されている

### 📚 成果物
- リファクタリング後のサービス層コード
- `app/utils/common.py` - 共通ユーティリティ
- `app/exceptions.py` - カスタム例外定義
- 各サービスの単体テスト

---

## 🎨 マイルストン 5: フロントエンド（WebUI）のモダン化
**期間目安**: 7-10日
**目標**: 保守性の高いフロントエンド構造への移行

### 📝 主要タスク

#### 5.1 フロントエンド構造の整理
- [ ] **コンポーネント化の推進**
  - [ ] JavaScriptコードのモジュール化（ES6 modules）
  - [ ] 再利用可能なUIコンポーネントの作成
  - [ ] グローバル変数の削減
- [ ] **HTMLテンプレートの改善**
  - [ ] Jinja2テンプレートの継承構造最適化
  - [ ] 共通レイアウトの抽出（`templates/base.html`）
  - [ ] パーシャルテンプレートの活用
- [ ] **CSSの整理**
  - [ ] CSS変数を使った色・スペーシング管理
  - [ ] レスポンシブデザインの統一
  - [ ] BEM命名規則の適用検討

#### 5.2 状態管理の改善
- [ ] **クライアントサイド状態管理**
  - [ ] シンプルな状態管理パターンの導入
  - [ ] localStorage/sessionStorageの適切な活用
  - [ ] WebSocketとの状態同期の明確化

#### 5.3 ビルドプロセスの導入（オプション）
- [ ] **開発効率化ツールの検討**
  - [ ] バンドラー導入の検討（Vite、Webpack等）
  - [ ] TypeScript導入の検討（段階的移行）
  - [ ] ホットリロード環境の構築

### ✅ 完了条件
- [ ] JavaScriptコードがモジュール化され、保守性が向上している
- [ ] UIコンポーネントが再利用可能な形で整理されている
- [ ] フロントエンドのテストが作成されている（E2Eテスト含む）
- [ ] 新規開発者がUI修正を30分以内に理解できる

### 📚 成果物
- モジュール化されたJavaScriptコード
- 整理されたHTMLテンプレート
- コンポーネント別のCSSファイル
- フロントエンド開発ガイド（`docs/development/frontend_guide.md`）

---

## 🔌 マイルストン 6: API設計の見直しとドキュメント化
**期間目安**: 5-7日
**目標**: 一貫性のあるRESTful API設計と包括的なドキュメント

### 📝 主要タスク

#### 6.1 APIエンドポイントの再設計
- [ ] **RESTful原則への準拠**
  - [ ] リソース指向のURL設計
  - [ ] HTTPメソッドの適切な使用（GET、POST、PUT、DELETE）
  - [ ] ステータスコードの一貫した使用
- [ ] **バージョニング戦略**
  - [ ] APIバージョニングの導入（`/api/v1/...`）
  - [ ] 後方互換性の保証方法の確立
- [ ] **レスポンス形式の統一**
  - [ ] 標準的なJSONレスポンス構造の定義
  - [ ] エラーレスポンスの統一フォーマット
  - [ ] ページネーション・ソート・フィルタの標準化

#### 6.2 API仕様書の作成
- [ ] **OpenAPI (Swagger) ドキュメント**
  - [ ] OpenAPI 3.0仕様での全エンドポイント定義
  - [ ] Swagger UIの導入（開発環境）
  - [ ] リクエスト・レスポンスの詳細な記載
- [ ] **API使用例の整備**
  - [ ] 各エンドポイントのcURLサンプル
  - [ ] Pythonクライアントサンプル
  - [ ] エラーケースのサンプル

#### 6.3 API認証・認可の検討（将来対応）
- [ ] **セキュリティ要件の整理**
  - [ ] 認証方式の検討（JWT、API Key等）
  - [ ] 認可レベルの設計（将来のマルチユーザー対応）
  - [ ] レート制限の検討

### ✅ 完了条件
- [ ] 全てのAPIエンドポイントがRESTful原則に従っている
- [ ] OpenAPI仕様書が完成し、Swagger UIで確認できる
- [ ] APIドキュメントを見れば、外部開発者が利用できる
- [ ] APIの統合テストが完備されている

### 📚 成果物
- `docs/api/openapi.yaml` - OpenAPI仕様書
- `docs/api/api_usage_guide.md` - API利用ガイド
- Swagger UIページ（開発環境）
- API統合テスト

---

## 🧪 マイルストン 7: 既存テスト整理とCI/CD構築（フェーズ2）
**期間目安**: 5-7日
**目標**: リファクタリング完了後に既存テストを新ルールに準拠させ、CI/CDパイプラインを構築する

> **重要**: このマイルストンでは、マイルストン4-6で実施したリファクタリングが完了していることを前提とします。既存テストを新ルール（マイルストン3で策定）に準拠するよう整理し、品質を自動的に保証するCI/CDパイプラインを構築します。

### 📝 主要タスク

#### 7.1 既存テストのリファクタリング
- [ ] **既存テストの監査**
  - [ ] 全既存テストのレビュー（`tests/`ディレクトリ内）
  - [ ] 新ルールに従っていないテストの洗い出し
    - 命名規則の不適合（`test_<機能>_<条件>_<期待結果>` に従っていない）
    - AAAパターンの未適用
    - 不適切なディレクトリ配置（unit/integration/e2eの分離ができていない）
  - [ ] リファクタリング優先順位の決定（重要度・影響範囲で評価）
  - [ ] リファクタリング計画の作成（Issue化・担当者決定）
- [ ] **既存テストの修正**
  - [ ] テストファイル・関数の命名規則への準拠
    - 例: `test_fetch.py` → `test_stock_data_fetcher.py`
    - 例: `test_download()` → `test_fetch_stock_data_returns_valid_data()`
  - [ ] AAAパターンへの書き直し（Arrange-Act-Assert）
    - セットアップ・実行・検証の明確な分離
    - コメントによる各セクションの明記（必要に応じて）
  - [ ] 適切なディレクトリへの移動
    - ユニットテスト → `tests/unit/`
    - 統合テスト → `tests/integration/`
    - E2Eテスト → `tests/e2e/`
  - [ ] フィクスチャの共通化とリファクタリング
    - 重複フィクスチャの`conftest.py`への集約
    - パラメータ化の活用によるテストケース削減
  - [ ] 不要なテストの削除または統合
    - 重複テストの統合
    - 価値のないテストの削除

#### 7.2 テストカバレッジの向上
- [ ] **ユニットテストの充実**
  - [ ] リファクタリングされた全サービスクラスのテスト作成（カバレッジ80%以上）
  - [ ] エッジケース・エラーケースのテスト
  - [ ] テストの可読性向上（AAA パターン: Arrange-Act-Assert）
- [ ] **統合テストの作成**
  - [ ] API統合テストの充実
  - [ ] データベース統合テストの作成
  - [ ] 外部API（Yahoo Finance）のモック化
- [ ] **E2Eテストの整備**
  - [ ] 主要ユースケースのE2Eテスト
  - [ ] ブラウザテストの自動化検討（Selenium、Playwright等）
- [ ] **テスト品質の向上**
  - [ ] テストの可読性改善
    - わかりやすいアサーションメッセージ
    - テストデータの明示的な命名
  - [ ] エッジケースの追加
    - 境界値テスト
    - エラーケースの網羅
  - [ ] テストカバレッジの向上（70%以上を目標）
    - カバレッジレポートでの未カバー箇所の特定
    - 優先度の高い箇所からテスト追加

#### 7.3 CI/CDパイプラインの構築
- [ ] **GitHub Actionsの設定**
  - [ ] プッシュ時の自動テスト実行
  - [ ] PRマージ前のテスト必須化
  - [ ] テストカバレッジレポート生成
- [ ] **品質ゲートの設定**
  - [ ] Linter（flake8、black、isort）の自動実行とエラー時のビルド失敗
  - [ ] 型チェック（mypy）の自動実行
  - [ ] セキュリティスキャン（bandit）の導入
  - [ ] コードカバレッジ閾値の設定（70%未満でビルド失敗）
  - [ ] 複雑度チェック（mccabe）の導入検討

### ✅ 完了条件
- [ ] **既存テストが新ルールに100%準拠している**
  - [ ] 全テストが命名規則に従っている
  - [ ] 全テストがAAAパターンで記述されている
  - [ ] 全テストが適切なディレクトリに配置されている
- [ ] 全体のテストカバレッジが70%以上
- [ ] CI/CDパイプラインが正常に動作している
- [ ] 新規PR作成時に自動テストが実行される
- [ ] テスト失敗時に明確なフィードバックが得られる

### 📚 成果物
- **リファクタリングされた既存テスト**
  - 新ルールに準拠したテストコード
  - 適切なディレクトリ構造に再編成されたテストファイル
  - リファクタリング前後の比較レポート（カバレッジ、可読性向上等）
- 充実したテストスイート（`tests/unit/`, `tests/integration/`, `tests/e2e/`）
- `.github/workflows/test.yml` - CI設定
- テストカバレッジレポート
- 品質ゲート設定ドキュメント

> **次のマイルストンへ**: この段階で、すべてのテストが新ルールに準拠し、CI/CDによる自動品質保証体制が確立されます。次のマイルストンでは、パフォーマンス最適化に注力できます。

---

## 🚀 マイルストン 8: パフォーマンス最適化とスケーラビリティ
**期間目安**: 5-7日
**目標**: 大規模データ処理とマルチユーザー対応の基盤構築

### 📝 主要タスク

#### 8.1 データベースパフォーマンスの最適化
- [ ] **クエリ最適化**
  - [ ] スロークエリの特定と改善
  - [ ] インデックス戦略の見直し
  - [ ] N+1問題の解消
- [ ] **接続管理の改善**
  - [ ] コネクションプーリングの最適化
  - [ ] セッション管理の改善
  - [ ] トランザクション範囲の最小化

#### 8.2 バックエンドパフォーマンスの向上
- [ ] **非同期処理の導入**
  - [ ] Celery等のタスクキューの導入検討
  - [ ] 長時間処理のバックグラウンド化
  - [ ] WebSocketによる進捗通知の最適化
- [ ] **キャッシング戦略**
  - [ ] Redis等のキャッシュレイヤー導入検討
  - [ ] 頻繁にアクセスされるデータのキャッシュ
  - [ ] キャッシュ無効化戦略の確立

#### 8.3 フロントエンドパフォーマンスの改善
- [ ] **レンダリング最適化**
  - [ ] 大量データ表示の仮想化（Virtual Scrolling）
  - [ ] 遅延ロードの実装
  - [ ] バンドルサイズの最適化

### ✅ 完了条件
- [ ] 10万件以上のデータでも3秒以内に表示される
- [ ] 同時10ユーザーでもレスポンスタイムが劣化しない
- [ ] バックグラウンド処理が安定稼働する
- [ ] パフォーマンステストが自動化されている

### 📚 成果物
- 最適化されたデータベーススキーマ
- キャッシュ戦略ドキュメント（`docs/architecture/caching_strategy.md`）
- パフォーマンステストスイート
- パフォーマンスモニタリングダッシュボード

---

## 📊 開発の進め方

### 🔄 推奨開発フロー
```
マイルストン1（基盤・ドキュメント化） → マイルストン2（開発環境整備）
                    ↓
         マイルストン3（テスト戦略策定）← 🔒 既存機能を保護
                    ↓
マイルストン4（バックエンド） → マイルストン5（フロントエンド） → マイルストン6（API設計）
         ↓ 既存テスト実行で機能保護
         ↓ 新規コードは新ルールでテスト作成
                    ↓
    マイルストン7（既存テスト整理+CI/CD） → マイルストン8（パフォーマンス最適化）
```

### ⚠️ 重要なポイント
- **段階的なリファクタリング**: 一度に全てを変えず、小さな単位で改善
- **テストファーストの継続**: リファクタリング時も既存機能を壊さない
- **ドキュメント駆動開発**: コード変更時は必ずドキュメントも更新
- **定期的なコードレビュー**: チーム全体での品質維持
- **パフォーマンス監視**: 改善前後の計測を必ず実施

### 📈 進捗管理方法
1. 各マイルストンをGitHub Milestoneとして作成
2. タスクごとにIssueを作成し、Milestoneに紐付け
3. Feature Branchでの開発（`feature/MS1-architecture-docs` 等）
4. Pull Requestでコードレビュー実施（最低1名のApprove必須）
5. マイルストン完了時に成果物レビューと振り返り

### 🌿 ブランチ運用の実践例

#### 新機能開発の流れ
```bash
# 1. mainブランチから最新を取得
git checkout main
git pull origin main

# 2. 機能ブランチを作成（Issue #123の場合）
git checkout -b feature/issue-123-add-bulk-download

# 3. 開発作業とコミット（Conventional Commits形式で）
git add .
git commit -m "feat: add bulk download service implementation"
git commit -m "test: add unit tests for bulk download service"

# 4. リモートにプッシュ
git push -u origin feature/issue-123-add-bulk-download

# 5. GitHub上でPull Request作成
# - PRテンプレートに従って記入
# - 関連Issue（#123）を記載
# - レビュアーを指定

# 6. コードレビュー後、承認されたらマージ
# - GitHub上でSquash and Mergeを実行（推奨）
# - ブランチは自動削除

# 7. ローカルのmainブランチを更新
git checkout main
git pull origin main
git branch -d feature/issue-123-add-bulk-download
```

#### バグ修正の流れ
```bash
# 1. バグ修正用ブランチ作成（Issue #456の場合）
git checkout main
git pull origin main
git checkout -b fix/issue-456-pagination-error

# 2. バグ修正とテスト追加
git commit -m "fix: resolve pagination NaN display issue"
git commit -m "test: add regression test for pagination"

# 3. プッシュとPR作成
git push -u origin fix/issue-456-pagination-error
# GitHub上でPR作成 → レビュー → マージ
```

#### ホットフィックスの流れ（緊急対応）
```bash
# 1. mainから直接ホットフィックスブランチ作成
git checkout main
git pull origin main
git checkout -b hotfix/critical-database-connection

# 2. 修正とテスト
git commit -m "fix: resolve critical database connection pool exhaustion"

# 3. 即座にレビュー依頼・マージ
# - 緊急の場合でも最低1名のレビューを必須とする
# - マージ後、速やかにリリース
```

### 🤝 共同開発体制の確立

#### コミュニケーション
- **週次ミーティング**: 進捗確認と課題共有
- **ペアプログラミング**: 複雑なリファクタリング時
- **知識共有セッション**: 新しい技術や設計パターンの共有
- **ドキュメントレビュー**: 技術文書の定期的な見直し

#### コードレビューの原則
1. **タイムリーなレビュー**: PR作成後24時間以内にレビュー開始
2. **建設的なフィードバック**: 問題点だけでなく改善案も提示
3. **小さなPR**: 1PR = 1機能/1修正を心がける（500行以下推奨）
4. **自動チェック優先**: Linter・テストは自動化し、人間はロジックレビューに集中
5. **学びの機会**: レビューを通じて知識を共有

#### コンフリクト解決ルール
1. **早期の同期**: 定期的に`main`ブランチをマージして最新化
2. **コミュニケーション**: 同じファイルを触る場合は事前に相談
3. **責任の所在**: コンフリクト解決は基本的にPR作成者が行う
4. **レビュアーの協力**: 複雑なコンフリクトはレビュアーと協力して解決

---

## 🎯 リファクタリング完了後の期待成果

### 📈 開発効率の向上
- **新機能追加時間**: 50%短縮（明確な責任分掌により）
- **バグ修正時間**: 40%短縮（テストカバレッジとドキュメントにより）
- **新規開発者のオンボーディング**: 1週間 → 1日に短縮

### 🚀 コード品質の向上
- **テストカバレッジ**: 70%以上（現状から大幅改善）
- **重複コード**: 80%削減
- **循環的複雑度**: 30%削減（シンプルな設計により）
- **技術的負債**: 60%削減

### 📊 保守性の向上
- **ドキュメントカバレッジ**: 100%（全コンポーネント文書化）
- **API仕様書**: OpenAPI準拠で完全自動生成
- **CI/CD自動化**: プッシュからデプロイまで全自動化

### 🤝 チーム協働の促進
- **コードレビュー時間**: 50%短縮（明確な基準とテンプレートにより）
- **コンフリクト発生率**: 70%削減（モジュール化とブランチ戦略により）
- **共通理解**: 100%（ドキュメント化とワークフロー統一により）
- **PR承認時間**: 24時間以内（明確なレビュー原則により）
- **ブランチ管理の混乱**: 0件（命名規則とライフサイクル管理により）

---

このリファクタリング計画により、共同開発がスムーズに進められる、保守性の高い株価データ管理システムが実現できます。

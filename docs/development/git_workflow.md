# Git ワークフロー - 品質ゲート設定

## 6. 品質ゲート設定

このドキュメントでは、リポジトリにおける品質ゲートの設定と運用について説明します。
品質ゲートは PR マージ前にコード品質を自動的に検証するために重要です。

### 6.1 概要

品質ゲートは以下の観点で自動チェックを行います:

- コードカバレッジ
- 複雑度（サイクロマティック複雑度）
- コードスタイル（lint）
- 型チェック（mypy など）

### 6.2 品質基準

品質ゲートで評価する基準の詳細を示します。

#### 6.2.1 コードカバレッジ

- 最低カバレッジ閾値: 70%（--cov-fail-under=70 を使用）

#### 6.2.2 複雑度チェック

- mccabe / flake8 の複雑度チェックを使用し、閾値は max-complexity = 10 を推奨します。

#### 6.2.3 コードスタイル

- flake8/black/isort によるコードスタイルチェックを実施します。

#### 6.2.4 型チェック

- mypy による静的型チェックを行います。必要な設定はプロジェクトルートの設定ファイルを参照してください。

### 6.3 pre-commitフックによる品質チェック

ローカル開発時は pre-commit フックを用いて、変更前に品質チェックを実行します。`.pre-commit-config.yaml` に flake8、mypy、complexity-check（mccabe）が設定されていることを確認してください。

### 6.4 GitHub Actionsによる品質チェック

CI 上では GitHub Actions ワークフローにより、以下を実行します:

- pytest によるユニット/統合テスト
- pytest-cov によるカバレッジ測定（--cov=app, --cov-fail-under=70）
- flake8 によるスタイル/複雑度チェック
- mypy による型チェック

ワークフローは失敗した場合に PR マージをブロックするよう設定してください。

### 6.5 品質ゲート失敗時の対応

品質ゲートが失敗した場合の推奨フロー:

1. CI のログを確認し、失敗原因を特定する。
2. 速やかに該当コミット/PR を修正する。小さな修正であれば force-push で差し戻し可能ですが、レビューを再度行ってください。
3. 問題が複雑な場合は関連チームにアラートを出し、根本原因を調査する。
---
参照: `docs/standards/git-workflow.md`, `.github/workflows/quality.yml`, `pyproject.toml`, `.pre-commit-config.yaml`
